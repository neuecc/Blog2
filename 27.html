<!DOCTYPE html>
<html dir="ltr" lang="ja">
<head>
    <meta charset="utf-8" />
    <title>neue cc</title>
    <link rel="shortcut icon" href="https://neue.cc/favicon.ico" />
	<link rel="stylesheet" href="https://neue.cc/style.css" type="text/css" media="screen" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/normalize-whitespace/prism-normalize-whitespace.min.js"></script>
    <div id="wrapper">
        <div id="header"></div>
        <div id="content"><h1><a href="https://neue.cc/2009/03/15_136.html">C#でカリー化</a></h1>
<ul class="date"><li>2009-03-15</li></ul>
<div class="entry_body"><p>LINQハァハァ→関数型言語？→Haskell！という感じに辿ってHaskellを勉強中なので、カリー化について。Haskell、の前にまずはC#で考える。例えば、たまーに見かける「a =&gt; b =&gt; c =&gt; a + b + c」のようなものがパッと見意味分からない。Haskellでも型定義Int-&gt;Int-&gt;Intみたいことやるので、それと同じなわけっぽいですけれど。</p>
<p>ゆっくり分解すると、「=&gt;」の左が引数、右が戻り値なのでa =&gt;( b =&gt; c =&gt; a + b + c) つまり Func&lt;int,???&gt;。???の部分もカッコでくくって b =&gt;( c =&gt; a + b + c) つまりFunc&lt;int,Func&lt;int,???&gt;&gt;。c=&gt;a+b+cは、見たまんまなのでFunc&lt;int,Func&lt;int,Func&lt;int,int&gt;&gt;&gt;ということになる。</p>
<p>冷静に解きほぐせばそんな難しくない。というわけで準備運動が済んだので、カリー化関数を作ろう。</p>
<pre><code class="language-csharp">// カリー化する関数
static Func&lt;T, Func&lt;U, V&gt;&gt; Currying&lt;T, U, V&gt;(Func&lt;T, U, V&gt; func)
{
    return t =&gt; u =&gt; func(t, u);
}

// 非カリー化する関数
static Func&lt;T, U, V&gt; UnCurrying&lt;T, U, V&gt;(Func&lt;T, Func&lt;U, V&gt;&gt; func)
{
    return (t, u) =&gt; func(t)(u);
}

// 例として使うx+yを返す関数
static int Sum(int x, int y)
{
    return x + y;
}

static void Main()
{
    int num1 = Sum(3, 5); // 普通に、8

    // Sumをカリー化する、関数はデリゲートに包む必要がある
    var CurriedSum = Currying((Func&lt;int, int, int&gt;)Sum);
    int num2 = CurriedSum(3)(5); // 当然、8

    var BindedSum = CurriedSum(3); // 3を部分適用する
    int num3 = BindedSum(5); // 勿論、8

    var UnCurriedSum = UnCurrying(CurriedSum); // 非カリー化
    int num4 = UnCurriedSum(3, 5); // 当然、Sum関数と一緒
}
</code></pre>
<p>多分、あってる、と思いたい。カリー化とは大雑把に言って「f(x,y) = g(x)(y)」ということのようなので、そうなるようバラしたり戻したり。そういえばで気付いたのですが、関数/ラムダ式をデリゲートに包む方法は</p>
<pre><code class="language-csharp">Func&lt;int&gt; test1 = () =&gt; 1;
var test2 = (Func&lt;int&gt;)(() =&gt; 2);
var test3 = new Func&lt;int&gt;(() =&gt; 3);
</code></pre>
<p>意外とバリエーションがある、気がする。ようは省略出来るだけでしょって話っぽいけど。単独で定義するときは1番を用いるかなー。癖でとりあえずvar、って書いてから、あー、これはnewするのダルいケースだった、varじゃなくてちゃんと書かなきゃ、と後ろに戻ったりするのがよくあって笑えない。</p>
<h2>クロージャ</h2>
<p>関数を返す関数繋がりでついでに、<a href="http://d.hatena.ne.jp/Gemma/20080129" title="関数型言語って何がすごいんですか - Gemmaの日記">関数型言語って何がすごいんですか - Gemmaの日記</a>からロケットのコードのC#版を。</p>
<pre><code class="language-csharp"> static void Main()
{
    Func&lt;int, Action&gt; Rocket = n =&gt; () =&gt; Console.WriteLine((n &gt; 0) ? (n--).ToString() : &quot;liftoff&quot;);
    var F = Rocket(3);
    var G = Rocket(3);
    F(); F(); F(); F(); // 行数使うのもアレなので横に並べます
    G(); G();
}
</code></pre>
<p>中々なスッキリ具合。function retrunが必要ない、というのがC#ラムダ式の強みですねえ。JavaScriptは(IEのせいもあって)function{return}が必須なのがカッタルイ。そんなことを思うと、C#はとても身軽で、個人的にはある意味とてもLightweightだと感じてしまったりする。</p>
<p>インテリセンスがりがり、コードスニペットがりがり、コードフォーマッタがりがりな上に乗っかっているので、軽快というか、Lightweight Languageが短距離走選手のようだとしたら、VS2008+C#は重武装+ロケットブースターで、それ自体は鈍重であっても、結果的にブースター付きのは強烈なスピードだよね、みたいな。軽快に書き進められるの自分の力じゃなくてVisualStudioの力でしょ、と思わないときもないけれど。</p>
</div>
<h1><a href="https://neue.cc/2009/03/12_140.html">LINQとeach_sliceと匿名Enum</a></h1>
<ul class="date"><li>2009-03-12</li></ul>
<div class="entry_body"><p>ToLookupで思ったのは、匿名Enumが欲しい。わざわざ外に定義するほどでもないけれど、ただの文字列で区分けするのは嫌だ。なんて思ったのは、以前<a href="http://neue.cc/2009/01/09_128.html" title="neue cc - リーダーボード分解">ジオメトリのランキングを引っ張ってくる</a>際にGroupByを使った時に思ったんだった。それにしても、改めて眺めてみると酷い、Firstの連発とか。しかし、昔とは違うんです、昔とは。冷静に問題を考えればきっと分かる。</p>
<p>ようするに配列を3つ刻みで分割したい。{3, 4, 631, 671, 7, 5, 82, 1, 2}とあったら、{[3,4,631],[671,7,5],[82,1,2]}に分けたい。一次元→二次元、ということかな？phpのarray_chunkやRubyのEnumerable#each_sliceがそれに相当する、っぽい。</p>
<p>しかし延々と考えてもさっぱり思い浮かばない。自分で思い浮かばない時は検索しよう、と検索したらすぐ出てきた。<a href="http://blogs.msdn.com/ericwhite/archive/2008/08/19/chunking-a-collection-into-groups-of-three.aspx">Eric White's Blog : Chunking a Collection into Groups of Three</a>。
3つ区切りでグループ分け、とはまさに考えている問題と同じ話。ただ、あの、このFirstの連打は私とやってること同じじゃん。</p>
<p>私のようなタコならともかく、他の人も似たようなことやってるし、もしくは拡張メソッドでループ回している例しか見つからないから、しょうがないかな、と諦め。きれない。ようはSkip().First()にせよFirst(predicate)にせよ、IEnumerable&lt;T&gt;状態だからいけない。何らかのキーで直接アクセス出来ればいいわけですよね？ お、ToLookupぢゃん！でも今回は中に入るのが一個であること確定なので、ToDictionaryが良いですね。そして、ふふ、滅多に出番のないGroupByのresultSelectorを使うときがついにきたようだ……。</p>
<pre><code class="language-csharp">// 3つ区切りで、[商品名,値段,売ってる場所]となっている配列を分解したい
string[] array = { &quot;大根&quot;, &quot;100&quot;, &quot;八百屋&quot;, &quot;豚肉&quot;, &quot;300&quot;, &quot;肉屋&quot;, &quot;イカ&quot;, &quot;150&quot;, &quot;魚屋&quot; };

// enumモドキの匿名型
var Key = new
{
    Name = Guid.NewGuid(),
    Price = Guid.NewGuid(),
    Shop = Guid.NewGuid()
};

var result = array.Select((value, index) =&gt; new
    {
        value,
        chunk = index / 3,
        attr = (index % 3 == 0) ? Key.Name :
               (index % 3 == 1) ? Key.Price :
               Key.Shop
    }).GroupBy(t =&gt; t.chunk, t =&gt; t, (k, g) =&gt; g.ToDictionary(t =&gt; t.attr, t =&gt; t.value))
    .Select(d =&gt; new
    {
        Name = d[Key.Name],
        Price = d[Key.Price],
        Shop = d[Key.Shop]
    });
</code></pre>
<p>できたー。最初のSelect時にバラしているので行数がSkip().First()より増えているのは突っ込みどころだけど、満足。あと、元の配列がきっかり3で割りきれないと、Dictionaryなので存在しないキーにアクセスしました例外が出て死んでしまいます。対策としてはToLookupにして[Key.Name].FirstOrDefault()を使う、というのがすぐに浮かんだけど、スッキリしないのは否めない。ていうかその辺も踏まえてもSkip().FirstOrDefault()のほうが賢いやり方な気がする……。</p>
<p>で、冒頭の匿名Enum云々は、匿名型を使って実現？してみました。値は、絶対に被らないもの、ということでGUIDを使ってみた。ただ、定義時に全部にGuid.NewGuid()というのがダルい。というか若干ヤケくそ気味なのは否めない。こちらも上手いやり方が思い浮かばず、ってそればっか。そもそもEnumモドキなら、intでいいし、もしくは&quot;商品名&quot;とか文字列を使えば普通に便利なので、GUIDは全く意味ないですね。しょうもな。というわけで、実際に使う場合(あるかなあ？)はGUIDじゃなくて文字列でやります……。</p>
</div>
<h1><a href="https://neue.cc/2009/03/07_139.html">回数サンドイッチ</a></h1>
<ul class="date"><li>2009-03-07</li></ul>
<div class="entry_body"><pre><code class="language-csharp">class Program
{
    static void Main()
    {
        // 何でもいい配列
        var array = Enumerable.Repeat(&quot;a&quot;, 10);

        // foreachで素直っぽくindexを付ける
        foreach (var item in array.Select((value, index) =&gt; new { value, index }))
        {
            Console.WriteLine(&quot;{0}:{1}&quot;, item.index, item.value);
        }

        // 拡張メソッドにしちゃう
        foreach (var item in array.WithIndex())
        {
            Console.WriteLine(&quot;{0}:{1}&quot;, item.Key, item.Value);
        }

        // foreachで使う場合は普通に外側にcount用の変数置いた方が……
        // indexの取れない拡張メソッド(ToLookupとか)へのチェイン時には便利に使えるかも
        var splittedArray = array.WithIndex().ToLookup(kvp =&gt; kvp.Key &lt; 5, kvp =&gt; kvp.Value);
    }
}

public static class ExtMethods
{
    public static IEnumerable&lt;KeyValuePair&lt;int, T&gt;&gt; WithIndex&lt;T&gt;(this IEnumerable&lt;T&gt; source)
    {
        int index = 0;
        foreach (var item in source)
        {
            yield return new KeyValuePair&lt;int, T&gt;(index++, item);
        }
    }
}
</code></pre>
<p>最近は、どこにでもあるゲーム雑感サイト→どこにでもあるプログラミング雑感サイト、に無理矢理シフトしようとして浮ついた無理無理感が漂っていますが、別に特にシフトしたいわけでもなく、せっかくなので3月は集中的に書いてみようかな、と思っただけですが空気的に不評な雰囲気を感じちゃってたりしなかったりは、とりあえず無視黙殺で進めようかと思うこの頃ですがいかがお過ごしでしょうか。</p>
<p>前々回、前回からまだ続いて、Selectでindexを取る話。<a href="http://blogs.wankuma.com/izmktr/archive/2009/02/17/168255.aspx" title="[C#]何度目の動き">[C#]何度目の動き</a>を見て、便利便利と思ったので簡単に使えるように拡張メソッドに放り込んでみた。KeyValuePairなんて名前じゃなくてIndexValuePairが良いんですが(笑) あるものは、そのまんま使うということで。</p>
<p>それ自体は別にforeachの外側にカウント用の変数置けばいいぢゃーん、という気がしなくもなくて困ったので、言い訳として、幾つかのメソッドがインデックス取れないから中間に挟む用として便利！と思うことにした。SelectとかWhereとか、大抵のものはFunc&lt;T,int,TResult&gt;も用意されているんだけどね。ToLookupとか、一部のものには無いんだね。</p>
</div>
<h1><a href="https://neue.cc/2009/03/06_138.html">C# LINQで左外部自己結合</a></h1>
<ul class="date"><li>2009-03-06</li></ul>
<div class="entry_body"><pre><code class="language-csharp">static void Main(string[] args)
{
    // 連続して同じ値が来る箇所だけを省いて取得する
    // この場合だと1,2,4,3,4,0が取れることを目指す
    int[] array = { 1, 2, 4, 4, 3, 3, 4, 0, 0 };
    var arrayWithIndex = array.Select((value, index) =&gt; new { value, index });

    var result =
        from orig in arrayWithIndex
        join alias in arrayWithIndex on orig.index equals alias.index - 1 into _
        from alias in _.DefaultIfEmpty()
        where alias == null || orig.value != alias.value
        select orig.value;
}
</code></pre>
<p>前回に引き続いてindex生成してゴニョゴニョするネタを考えたい。というわけで、SQL的な自己結合。これで前後の値との比較が可能になるわけですね！ 自己結合自体は普通にjoinで同じソースを置くだけ。例では、「連続して同じ値が入っている箇所」を省くため、インデックスを1つずらして結合。ただ、普通に結合すると最後の値が無いので、結合から抜け落ちてしまう。というわけで、内部結合ではなく外部結合にする。外部結合はDefaultIfEmptyを使って、<a href="http://msdn.microsoft.com/ja-jp/library/bb397895.aspx">MSDNに記事がある</a>のをそのまんまな方向で。</p>
<pre><code class="language-csharp">var list = new List&lt;int&gt;();
list.Add(array[0]);
for (int i = 1; i &lt; array.Length; i++)
{
	if (array[i] != array[i - 1]) list.Add(array[i]);
} 
</code></pre>
<p>……でも結局、こんな例ならばList使った方が遥かにスッキリなのであった。意味ないねー。とても。少しはまともな例題が考え出せやしないものなのかしらん。</p>
</div>
<h1><a href="https://neue.cc/2009/03/03_137.html">リストの分割</a></h1>
<ul class="date"><li>2009-03-03</li></ul>
<div class="entry_body"><pre><code class="language-csharp">// リスト自体は何だっていいので適当に生成
var list = Enumerable.Repeat(&quot;a&quot;, 50);
// 25以下をtrue、それ以上をfalseとするkeyでグループ分け
var result = list
	.Select((value, index) =&gt; new { value, index })
	.GroupBy(t =&gt; t.index &lt;= 25, t =&gt; t.value);
// 多分、こんな感じに取り出す……？
var first = result.Single(g =&gt; g.Key == true);
var second = result.Single(g =&gt; g.Key == false);
</code></pre>
<p>2ch見てたら、要素数50のリストを0-25と26-50に分割するのどーするの、という質問が出てたのでごにゃごにゃ考えた。最初、list.GroupBy(i =&gt; i &lt; 25);なんて答えたのだけど、即座に値じゃなくて添え字で分けたいんでしょーがボケ、と突っ込みが入ったので書き換えたのが↑のもの。微妙な長さと無駄手間感が何とも言えない、ただのLINQ遊びでしかない状態になってしまった。うーん。これはこれで面白いと思うのだけど。ただ、もう少し短くできないかな……？グループ化が挟まると、その後がどうしても長ったらしく。ていうか、あと、trueとfalseしかないんだから、First()とLast()でいいよね、という話ではある。</p>
<pre><code class="language-csharp">// 条件ばかりが無駄に多くて限りなく微妙
var alphabet = Enumerable.Range('A', 'z' + 1 - 'A')
	.Where(c =&gt; c &lt;= 'Z' || c &gt;= 'a')
	.GroupBy(c =&gt; c &lt;= 'Z', c =&gt; (char)c);
// ていうか、意味ないよね、これ、全く
var upper = alphabet.First();
var lower = alphabet.Last();
</code></pre>
<p>何だか悔しいので、もう少し考えてみた。例えばアルファベットの大文字と小文字とか！……意味ない。死ぬほど意味がない。少なくとも、これだけを考えるならEnumerable.Range('a', 26).Select(i =&gt; ((char)i).ToString());でいいし。ダメだこりゃ。</p>
<h2>追記</h2>
<p>あ、違う、こういう場合はGroupByじゃなくてToLookup使えばいいんだった。GroupByと違ってキーでアクセス出来るようになるから、SingleだのFirstだのといった微妙なアクセスじゃなく(しかも、これらを使うと毎回走査してるってことだよね！) result[true]とかalphabet[true]とかでアクセス出来る。これで遙かにスッキリ。Lookupは素晴らしい。けど、ついつい忘れてしまう。</p>
<pre><code class="language-csharp">var result = list
	.Select((value, index) =&gt; new { value, index })
	.ToLookup(t =&gt; (t.index &lt;= 25) ? &quot;以下&quot; : &quot;より上&quot;, t =&gt; t.value);
var ika = result[&quot;以下&quot;]; // こんな感じで
var tako = result[&quot;より上&quot;]; // 取り出せるわけです！
</code></pre>
<p>これならすっきり。めでたしめでたし。キーは日本語でもboolでもenumでも好きなモノを使うといいさあー。</p>
<h2>追追記</h2>
<p><a href="http://d.hatena.ne.jp/NyaRuRu/20080602/p2" title="さっそく Enumerable.ToLookup が役立った - NyaRuRuの日記">さっそく Enumerable.ToLookup が役立った - NyaRuRuの日記</a><br />
つまりこういうことなのであった。間違いなく昔読んだはずなのに、すっかり忘れていたという事実が何よりも悲しい。あと、<a href="http://www.google.com/search?q=ToLookup" title="ToLookup - Google 検索">ToLookupで検索</a>しても全然引っかからないというのが、限りなく人気無いメソッドのようで悲しい。私も忘れてたけどね！</p>
</div>
<h1><a href="https://neue.cc/2009/02/28_135.html">C#とLINQでFizzBuzz</a></h1>
<ul class="date"><li>2009-02-28</li></ul>
<div class="entry_body"><pre><code class="language-csharp">using System;
using System.Collections.Generic;
using System.Linq;

class Program
{
    static void Main()
    {
        // FizzBuzzの無限リスト
        var FizzBuzz = Enumerable.Range(0, int.MaxValue).Select(i =&gt;
            (i % 15 == 0) ? &quot;FizzBuzz&quot; :
            (i % 3 == 0) ? &quot;Fizz&quot; :
            (i % 5 == 0) ? &quot;Buzz&quot; :
            i.ToString());

        // Skipが起点、Takeが表示数に対応する
        FizzBuzz.Skip(1).Take(100).ForEach((s, i) =&gt; Console.WriteLine(&quot;{0,3}:{1}&quot;, i + 1, s));
    }
}

public static class ExtensionMethods
{
    // indexが取れるForEach
    public static void ForEach&lt;T&gt;(this IEnumerable&lt;T&gt; source, Action&lt;T, int&gt; action)
    {
        int index = 0;
        foreach (var item in source) { action(item, index++); }
    }
}
</code></pre>
<p>何だかふと思って、今更ながらに<a href="http://golf.shinh.org/p.rb?FizzBuzz" title="anarchy golf - FizzBuzz">anarchy golf - FizzBuzz</a>をやってた。とりあえずC#でSize 123で同率一位達成なので満足です。以上。で終わるのもアレなので、記念にFizzBuzzをきちんと書くならどうなるかなあ、と考えてみた。</p>
<p>C#3.0だとLINQを使うのがきっとスマートです、よね。無限リストを作ってやるのが一番、かな。Skipがstart、Takeがcountに相当するってのが何だか面白い。しかし毎度ながらEnumerable.Range(0,int.MaxValue)という表記が冗長に過ぎてげんなり。あとIEnumerableにForEachが用意されてないのもなあ。ToList()は色々と違うと思うので、本当に何とかして欲しい。</p>
</div>
<h1><a href="https://neue.cc/2009/01/14_130.html">UbiquityとJavaScript</a></h1>
<ul class="date"><li>2009-01-14</li></ul>
<div class="entry_body"><p class="noindent">
	<img src="http://neue.cc/wp-content/uploads/image/ubiquitygwre2re1.jpg">
</p>
<p class="noindent">
	<img src="http://neue.cc/wp-content/uploads/image/ubiquitygwre2re2.jpg">
</p>
<p><a href="http://gist.github.com/46381" title="gist: 46381 — GitHub">gist: 46381 — GitHub</a></p>
<p>あまりの酷いJavaScript素人っぷりに嫌気がさしたので、<a href="http://www.amazon.co.jp/gp/product/4873113296?ie=UTF8&tag=ilsgeometrati-22&linkCode=as2&camp=247&creative=7399&creativeASIN=4873113296">JavaScript 第5版</a><img src="http://www.assoc-amazon.jp/e/ir?t=ilsgeometrati-22&l=as2&o=9&a=4873113296" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />を読みました。とりあえず9章まで。というわけで、それをもとにして書きなおしてみました。functionがコンストラクタなんだねー、とかprototypeとか。そんな感想を反映。前よりは遥かにマシ、だとは思います。</p>
<p>んで、機能的には大幅アップです。modeを確定させる前は全部のモードから表示。modeを確定させたら、前回はプレビュー領域が余りまくりで勿体なかったので、前後3人のスコアを同時表示に変更。これでわりと実用的になってきたんじゃあないかと思われますがどうでしょう？若干、というかかなり動作が怪しいー通信しすぎー、一覧表示でてこねーぞごるぁー、ってところがあるので、追々直します。</p>
</div>
<h1><a href="https://neue.cc/2009/01/13_129.html">ジオメトリランキング表示Ubiquityコマンド</a></h1>
<ul class="date"><li>2009-01-13</li></ul>
<div class="entry_body"><p class="noindent">
	<img src="http://neue.cc/wp-content/uploads/image/ubiquitygwre2.jpg">
</p>
<p><a href="http://gist.github.com/46381" title="gist: 46381 — GitHub">gist: 46381 — GitHub</a></p>
<p>ちょっと前からゴニョゴニョと弄り中のジオメトリウォーズ2のランキング。実用的なものを、と考えた結果、Firefoxのアドオン<a href="http://labs.mozilla.com/projects/ubiquity/">Ubiquity</a>のコマンドに仕上げてみました。Ubiquityをインストールした状態で上記GitHubのサイトに飛ぶと上部にSubscribeするかどうかの情報バーが出るので、Subscribeすればコマンドのインストールが完了します。</p>
<h2>使い方</h2>
<p>Ubiquityを起動し(デフォルトではCtrl+Space)「gwre2 GAMERTAG mode MODE」とコマンドを入力するとプレビュー領域にランキングとスコアが表示され、そのままエンターキーを押すと、テキストキャレットの位置にスコアが挿入されます。例えば「gwre2 SeaWeeze mode Deadline」と入力すると「Rank:143|Score:45218795」がプレビュー領域に、エンターを押すことで「45218795」が挿入される、というわけです。</p>
<p>入力補完が効くので実際の入力は「gw SeaWeeze mode d」だけでOKです。また、modeを入力すると下にその他の候補が出るので、下カーソルを押すことでスムーズに他のモードのランク/スコアを見ることが可能です。残念ながら今のところUbiquityの仕様で5つまでしか出せませんけど(モードは6つあるので一つ足りない、ので基本的にSequenceが場外)</p>
<p>ネットを見ててゲーマータグがあると、この人のジオメトリのスコアはどのぐらいだろうなあ、とかすぐ思ってしまう人にお薦め。定期的に自分のスコアを張り付けている人にもお薦め。もうメモらなくても済む！</p>
<h2>コード品質</h2>
<p>ソースコード丸見え！見ちゃいやあ。そうです、品質最悪です。実のところjavascriptが全然分からないのです。そしてjQueryは初めて触った、ので全く分からない。Ubiquityも初めて、当然さっぱり。分からないx3により酷いことになっています。いやあ、困った困った。誰か改良してくれれば……。というのはともかく、明らかに酷いのは分かっているので、ちょくちょくと改良していこうとは思っています。</p>
<p>modeを入力しない状態だとpreview領域に全部のスコアとランクを出す。というほうが便利ですよねー。ただそうなるとサーバーにリクエスト飛ばしまくることになるので(単純にx6というだけじゃなくて、ゲーマータグの確定前にもリクエストが飛ぶので、x15ぐらいになりそう)どうかなー、と思ったんですが、どーなんでしょうかね。やっぱ不便なので、全部のスコアとランクが出た方がいいには違いないんですけどねえ。</p>
</div>
<h1><a href="https://neue.cc/2009/01/09_128.html">リーダーボード分解</a></h1>
<ul class="date"><li>2009-01-09</li></ul>
<div class="entry_body"><p class="noindent">
	<img src="http://neue.cc/wp-content/uploads/image/geoleaderboardlinq.jpg">
</p>
<pre><code class="language-csharp"> static void Main(string[] args)
 {
     var service = new XBLLeaderboardSvc.ServiceSoapClient(&quot;ServiceSoap&quot;);
     var result = service.getLeaderboardNearGamertag(2, 4, &quot;SeaWeeze&quot;, 10)
         .Skip(1) // 最初の1個目は値の個数なのでスキップ
         .Select((value, index) =&gt; new
         {
             value = value,
             index = index / 3,
             attr = (index % 3 == 0) ? &quot;Rank&quot; :
                    (index % 3 == 1) ? &quot;Tag&quot; :
                    &quot;Score&quot;
         })
         .GroupBy(t =&gt; t.index, t =&gt; new { t.value, t.attr })
         .Select(g =&gt; new
         {
             tag = g.First(t =&gt; t.attr == &quot;Tag&quot;).value,
             rank = int.Parse(g.First(t =&gt; t.attr == &quot;Rank&quot;).value),
             score = int.Parse(g.First(t =&gt; t.attr == &quot;Score&quot;).value)
         });
 }
</code></pre>
<p>今年はプログラミング分を強化したいので、コードも張り付けていこう。勿論恥ずかしいけれど、照れてても成長に繋がらないと思うので、積極的に行きたいです。言語は基本的にC#3.0。というわけで、<a href="http://neue.cc/2009/01/05_126.html" title="neue cc - GeometryWars Leaderboard API">前回、GeometryWarsのLeaderboardの値を取得する</a>の続き。ただの文字列配列で帰ってくるので分解しなきゃねー、ということで分解、まで。この後の予定は未定。ゆったりとSilverlightで簡単なグラフでも作ってから本格的に考えようかな―、と思っています。</p>
<p>サービス参照を追加するだけで、メソッド一発(getLeaderboardNearGamertag())で軽く取得出来る。これは楽ちん。配列はLINQを使って分解することにしました。3つ区切りなので3で割ってインデックスと属性振ってグループ化してタグから匿名型作って……。何かイマイチ。attrが野暮ったい。この辺、何とかしたい気はとてもする。</p>
<p>と、進捗的にはつまり全く進んでないということですね！ いや、ここずっとexception conflictやってるし……。</p>
</div>
<h1><a href="https://neue.cc/2009/01/05_126.html">GeometryWars Leaderboard API</a></h1>
<ul class="date"><li>2009-01-05</li></ul>
<div class="entry_body"><p>Xbox360がネットランキングを標準搭載したように、次世代XboxはWeb上からランキングデータを取得できるAPIを標準公開して欲しい。いや、公開すべき。そうすれば、あんなこともこんなことも、夢が膨らむ。残念ながら現行世代のXbox360はム・リ。ではあるものの、最近ではウェブ上からランキングを参照出来るゲームも多くなってきた、ということは需要の後押しがある、ということで次世代Xboxでの搭載は夢ではなさそう。HALO3のマッチングシステムと共に標準搭載の勢いでよろしくお願いしたい。</p>
<p>で、本題。ジオメトリ2もメーカー側のランキングや、ランキング付きゲーマーカードのようにウェブ上に公開可能な仕組みは用意されていた、けど、一般人が弄れるAPIは公開されていなかった。しかしBizarre Creationsはついにやってくれた。さらっと<a href="http://www.bizarrecreations.com/forum/viewtopic.php?f=26&amp;t=16965" title="View topic - Overall Leaderboards? - Bizarre Creations">BBS上に公開したよー、とのお知らせ</a>が！</p>
<p>というわけで、そのBizarre CreationsのXBLAタイトル用の<a href="http://www.bizarrecreations.com/XBLLeaderboardSvc/Service.asmx">Leadboard取得WebService</a>の解説。呼び出し方法が数字直打ちで分かりづらければ、帰ってくる値も素の配列という分かりづらさなので、私が調べた範囲で簡単に解説します。いや、数字ぽてぽて打って確認するだけで別に手間でもなんでもないですけどね。</p>
<p>getLeaderboardは順位のランキング。Overallって奴ですね。パラメータはgameIdとleaderboardIdはあとで解説します。rankToStartで開始する順位を、numToShowで取得する量を決めます。残念ながらrankToStartは901まで、numToShowも有効なのは100まで、ということで1000位までしか取得できません。十分ですけど。</p>
<p>getLeaderboardNearGamertagは任意のゲーマータグの人の前後のランキングを取得する。gamerTagはゲーマータグ、numToShowは前後の量。こちらのnumToShowは有効な値は101までになっています。自分の前に50人+自分の後ろに50人、ということですね。</p>
<p>さて、gameIdですけど、0はGWRE1、1はBoomBoomRocket、2はGWRE2。GWRE1のleaderboardIdは、0がEVOLVED、1がRETRO。BoomBoomRocketは割愛(笑) GWRE2は、0=Deadline,1=Evolved,2=Sequence,3=Waves,4=Pacifism,5=Kingでした。変な並び順ですけど気にしないことにしましょう。いや、めっちゃ気になるけど。</p>
<p>で、取得できるxmlは全部stringというそっけなさ。一番目が取得したデータの個数、それ以降は3つ区切りで「順位、ゲーマータグ、スコア」になっているようです。</p>
<p>ついでにRESTでの取得。<a href="http://www.bizarrecreations.com/XBLLeaderboardSvc/Service.asmx/getLeaderboardNearGamertag?gameId=2&amp;leaderboardId=4&amp;gamerTag=SeaWeeze&amp;numToShow=11">http://www.bizarrecreations.com/XBLLeaderboardSvc/Service.asmx/getLeaderboardNearGamertag?gameId=2&amp;leaderboardId=4&amp;gamerTag=SeaWeeze&amp;numToShow=11</a>、このURLはgameIdが2なのでGWRE2、leaderboardIdが4なのでPacifism、gamerTagがSeaWeezeなので、まあ、私ですね、で、numToShowが11なので前後5人ずつのランキングが取得出来ます。</p>
<p>いやあ、素晴らしいですね。色々と素っ気なさ過ぎじゃね？って気がしなくもないですが、それが非公開のサービスを一般向けに公開してあげる、という優しさに感じられて嬉しかったりして。実際問題、こんなに大盤振る舞いで公開してくれている会社なんて無いですからねえ。今後もBizarreに続いてくれると(Bungieぐらいかな、もしやるとしても)嬉しいし、その勢いで次世代Xboxでは公開が当然、みたいな形になってくれれば、なお嬉しい。</p>
<p>そのためにも、せっかく公開してくれたこのサービスを使って何かを作らなければ！と思うんだけど、いざ何かっていうと何も思い浮かばない。プログラム流用で、ランキングが100落ちる度にTwitterに投稿するツールとか、どうでもいいネタしか浮かばない。というわけで、何かアイディアがあればください。</p>
</div>
<a href="https://neue.cc//26">Prev |</a>
</div>
        <div id="side">
<h3>Profile</h3>
<div class="side_body" align="center">
<b>Yoshifumi Kawai</b><br />
<br />
<a href="https://cysharp.co.jp/">Cysharp, Inc</a><br />
CEO/CTO<br />
<br />
Microsoft MVP for Developer Technologies(C#)<br />
April 2011<br />
|<br />
July 2022<br />
<br />
Twitter:<a href="https://twitter.com/neuecc/">@neuecc</a>
GitHub:<a href="https://github.com/neuecc/">neuecc</a>
</div>

<h3>Archive</h3>
<div class="side_body">
<ul>
<li><a href="https://neue.cc/2021/08/">2021-08</a>
<li><a href="https://neue.cc/2021/07/">2021-07</a>
<li><a href="https://neue.cc/2021/05/">2021-05</a>
<li><a href="https://neue.cc/2021/02/">2021-02</a>
<li><a href="https://neue.cc/2020/12/">2020-12</a>
<li><a href="https://neue.cc/2020/11/">2020-11</a>
<li><a href="https://neue.cc/2020/10/">2020-10</a>
<li><a href="https://neue.cc/2020/08/">2020-08</a>
<li><a href="https://neue.cc/2020/07/">2020-07</a>
<li><a href="https://neue.cc/2020/04/">2020-04</a>
<li><a href="https://neue.cc/2020/01/">2020-01</a>
<li><a href="https://neue.cc/2019/12/">2019-12</a>
<li><a href="https://neue.cc/2019/09/">2019-09</a>
<li><a href="https://neue.cc/2019/08/">2019-08</a>
<li><a href="https://neue.cc/2019/07/">2019-07</a>
<li><a href="https://neue.cc/2019/06/">2019-06</a>
<li><a href="https://neue.cc/2019/05/">2019-05</a>
<li><a href="https://neue.cc/2019/04/">2019-04</a>
<li><a href="https://neue.cc/2018/12/">2018-12</a>
<li><a href="https://neue.cc/2018/10/">2018-10</a>
<li><a href="https://neue.cc/2018/08/">2018-08</a>
<li><a href="https://neue.cc/2018/07/">2018-07</a>
<li><a href="https://neue.cc/2018/05/">2018-05</a>
<li><a href="https://neue.cc/2018/04/">2018-04</a>
<li><a href="https://neue.cc/2018/01/">2018-01</a>
<li><a href="https://neue.cc/2017/12/">2017-12</a>
<li><a href="https://neue.cc/2017/09/">2017-09</a>
<li><a href="https://neue.cc/2017/08/">2017-08</a>
<li><a href="https://neue.cc/2017/07/">2017-07</a>
<li><a href="https://neue.cc/2017/06/">2017-06</a>
<li><a href="https://neue.cc/2017/04/">2017-04</a>
<li><a href="https://neue.cc/2017/03/">2017-03</a>
<li><a href="https://neue.cc/2016/12/">2016-12</a>
<li><a href="https://neue.cc/2016/11/">2016-11</a>
<li><a href="https://neue.cc/2016/10/">2016-10</a>
<li><a href="https://neue.cc/2016/09/">2016-09</a>
<li><a href="https://neue.cc/2016/08/">2016-08</a>
<li><a href="https://neue.cc/2016/07/">2016-07</a>
<li><a href="https://neue.cc/2016/06/">2016-06</a>
<li><a href="https://neue.cc/2016/05/">2016-05</a>
<li><a href="https://neue.cc/2016/04/">2016-04</a>
<li><a href="https://neue.cc/2016/03/">2016-03</a>
<li><a href="https://neue.cc/2016/01/">2016-01</a>
<li><a href="https://neue.cc/2015/12/">2015-12</a>
<li><a href="https://neue.cc/2015/11/">2015-11</a>
<li><a href="https://neue.cc/2015/10/">2015-10</a>
<li><a href="https://neue.cc/2015/09/">2015-09</a>
<li><a href="https://neue.cc/2015/06/">2015-06</a>
<li><a href="https://neue.cc/2015/05/">2015-05</a>
<li><a href="https://neue.cc/2015/04/">2015-04</a>
<li><a href="https://neue.cc/2015/03/">2015-03</a>
<li><a href="https://neue.cc/2015/02/">2015-02</a>
<li><a href="https://neue.cc/2015/01/">2015-01</a>
<li><a href="https://neue.cc/2014/12/">2014-12</a>
<li><a href="https://neue.cc/2014/11/">2014-11</a>
<li><a href="https://neue.cc/2014/10/">2014-10</a>
<li><a href="https://neue.cc/2014/09/">2014-09</a>
<li><a href="https://neue.cc/2014/08/">2014-08</a>
<li><a href="https://neue.cc/2014/07/">2014-07</a>
<li><a href="https://neue.cc/2014/05/">2014-05</a>
<li><a href="https://neue.cc/2014/04/">2014-04</a>
<li><a href="https://neue.cc/2014/03/">2014-03</a>
<li><a href="https://neue.cc/2014/01/">2014-01</a>
<li><a href="https://neue.cc/2013/12/">2013-12</a>
<li><a href="https://neue.cc/2013/11/">2013-11</a>
<li><a href="https://neue.cc/2013/10/">2013-10</a>
<li><a href="https://neue.cc/2013/09/">2013-09</a>
<li><a href="https://neue.cc/2013/08/">2013-08</a>
<li><a href="https://neue.cc/2013/07/">2013-07</a>
<li><a href="https://neue.cc/2013/06/">2013-06</a>
<li><a href="https://neue.cc/2013/05/">2013-05</a>
<li><a href="https://neue.cc/2013/04/">2013-04</a>
<li><a href="https://neue.cc/2013/03/">2013-03</a>
<li><a href="https://neue.cc/2013/02/">2013-02</a>
<li><a href="https://neue.cc/2013/01/">2013-01</a>
<li><a href="https://neue.cc/2012/12/">2012-12</a>
<li><a href="https://neue.cc/2012/11/">2012-11</a>
<li><a href="https://neue.cc/2012/10/">2012-10</a>
<li><a href="https://neue.cc/2012/09/">2012-09</a>
<li><a href="https://neue.cc/2012/08/">2012-08</a>
<li><a href="https://neue.cc/2012/07/">2012-07</a>
<li><a href="https://neue.cc/2012/06/">2012-06</a>
<li><a href="https://neue.cc/2012/05/">2012-05</a>
<li><a href="https://neue.cc/2012/04/">2012-04</a>
<li><a href="https://neue.cc/2012/03/">2012-03</a>
<li><a href="https://neue.cc/2012/02/">2012-02</a>
<li><a href="https://neue.cc/2012/01/">2012-01</a>
<li><a href="https://neue.cc/2011/12/">2011-12</a>
<li><a href="https://neue.cc/2011/11/">2011-11</a>
<li><a href="https://neue.cc/2011/10/">2011-10</a>
<li><a href="https://neue.cc/2011/09/">2011-09</a>
<li><a href="https://neue.cc/2011/08/">2011-08</a>
<li><a href="https://neue.cc/2011/07/">2011-07</a>
<li><a href="https://neue.cc/2011/06/">2011-06</a>
<li><a href="https://neue.cc/2011/05/">2011-05</a>
<li><a href="https://neue.cc/2011/04/">2011-04</a>
<li><a href="https://neue.cc/2011/03/">2011-03</a>
<li><a href="https://neue.cc/2011/02/">2011-02</a>
<li><a href="https://neue.cc/2011/01/">2011-01</a>
<li><a href="https://neue.cc/2010/12/">2010-12</a>
<li><a href="https://neue.cc/2010/11/">2010-11</a>
<li><a href="https://neue.cc/2010/10/">2010-10</a>
<li><a href="https://neue.cc/2010/09/">2010-09</a>
<li><a href="https://neue.cc/2010/08/">2010-08</a>
<li><a href="https://neue.cc/2010/07/">2010-07</a>
<li><a href="https://neue.cc/2010/06/">2010-06</a>
<li><a href="https://neue.cc/2010/05/">2010-05</a>
<li><a href="https://neue.cc/2010/04/">2010-04</a>
<li><a href="https://neue.cc/2010/03/">2010-03</a>
<li><a href="https://neue.cc/2010/02/">2010-02</a>
<li><a href="https://neue.cc/2010/01/">2010-01</a>
<li><a href="https://neue.cc/2009/12/">2009-12</a>
<li><a href="https://neue.cc/2009/11/">2009-11</a>
<li><a href="https://neue.cc/2009/10/">2009-10</a>
<li><a href="https://neue.cc/2009/09/">2009-09</a>
<li><a href="https://neue.cc/2009/08/">2009-08</a>
<li><a href="https://neue.cc/2009/07/">2009-07</a>
<li><a href="https://neue.cc/2009/06/">2009-06</a>
<li><a href="https://neue.cc/2009/05/">2009-05</a>
<li><a href="https://neue.cc/2009/04/">2009-04</a>
<li><a href="https://neue.cc/2009/03/">2009-03</a>
<li><a href="https://neue.cc/2009/02/">2009-02</a>
<li><a href="https://neue.cc/2009/01/">2009-01</a>
</ul>
</div>
</div>
        <div id="footer"><ul>
<li>Index: <a href=\"https://neue.cc\">neue.cc</a><li>
<li>Powered by: <a href=\"https://github.com/neuecc/Blog2\">https://github.com/neuecc/Blog2</a>
</ul></div>
    </div>
</body>
